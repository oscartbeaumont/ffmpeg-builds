name: Build and Publish

on:
  push:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      doRelease:
        description: 'Publish new release'
        type: boolean
        default: false
        required: false
      buildOnly:
        description: 'Only build ffmpeg'
        type: boolean
        default: false
        required: false
  schedule:
    - cron: '0 12 * * *'

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Build
        run: .\build.ps1
        # && tar -zcvf ./x64_64.tar.gz ./ffmpeg/dist_x64_64

      # - name: Release
      #   uses: softprops/action-gh-release@v1
      #   if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     files: |
      #       arm64.tar.gz
      #       x64_64.tar.gz

  macOS:
    runs-on: macos-12
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Cache Brew deps
        uses: actions/cache@v3.0.9
        with:
          # Paths to cache:
          # /usr/local/Homebrew - installation folder of Homebrew
          # /usr/local/Cellar - installation folder of Homebrew formulae
          # /usr/local/Frameworks, /usr/local/bin, /usr/local/opt - contain (links to) binaries installed by Homebrew formulae
          # /usr/local/lib/python3.8 - Python3 packages installation
          path: |
            /usr/local/Homebrew
            /usr/local/Cellar
            /usr/local/Frameworks
            /usr/local/bin
            /usr/local/opt
            /usr/local/lib/python3.8
          key: brew-deps-${{ hashFiles('./Brewfile') }}-v2
      
      - name: Instal Brew deps
        run: brew bundle

      # - name: Build for macOS arm64
      #   run: ./build.sh arm64 && tar -zcvf ./arm64.tar.gz ./ffmpeg/dist_arm64 # TODO: Build all the dependencies for M1 and this should be good

      - name: Build for macOS x64_64
        run: ./build.sh x64_64 && tar -zcvf ./x64_64.tar.gz ./ffmpeg/dist_x64_64

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            arm64.tar.gz
            x64_64.tar.gz
  
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build
        run: ./build.sh x64_64 && tar -zcvf ./x64_64.tar.gz ./ffmpeg/dist_x64_64

      # - name: Release
      #   uses: softprops/action-gh-release@v1
      #   if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     files: |
      #       arm64.tar.gz
      #       x64_64.tar.gz